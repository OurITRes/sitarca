AWSTemplateFormatVersion: '2010-09-09'
Description: adcyberwatch-infra
Transform:
- AWS::Serverless-2016-10-31
Resources:
  RawBucket:
    Type: AWS::S3::Bucket
    Properties:
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  CuratedBucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  FrameworksBucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  AdCyberwatchMainTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: adcyberwatch-main
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
  AdCyberwatchUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: ${AWS::StackName}-userpool
      UsernameAttributes:
      - email
      AutoVerifiedAttributes:
      - email
  AdCyberwatchUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: AdCyberwatchUserPool
      ClientName: spa
      GenerateSecret: false
      PreventUserExistenceErrors: ENABLED
      ExplicitAuthFlows:
      - ALLOW_USER_SRP_AUTH
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      - ALLOW_ADMIN_USER_PASSWORD_AUTH
      AllowedOAuthFlows:
      - code
      - implicit
      AllowedOAuthScopes:
      - email
      - openid
      - profile
      AllowedOAuthFlowsUserPoolClient: true
      CallbackURLs:
      - http://localhost:5173/callback
      - http://localhost:5173
      LogoutURLs:
      - http://localhost:5173
      SupportedIdentityProviders:
      - COGNITO
  AdCyberwatchIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName:
        Fn::Sub: ${AWS::StackName}-identity-pool
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
      - ClientId:
          Ref: AdCyberwatchUserPoolClient
        ProviderName:
          Fn::Sub: cognito-idp.${AWS::Region}.amazonaws.com/${AdCyberwatchUserPool}
  AdCyberwatchIdentityPoolRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${AWS::StackName}-identity-pool-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
          Action: sts:AssumeRoleWithWebIdentity
          Condition:
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: AdCyberwatchIdentityPool
            ForAnyValue:StringEquals:
              cognito-identity.amazonaws.com:amr: authenticated
      Policies:
      - PolicyName: S3Access
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            - s3:GetObject
            Resource:
            - Fn::Sub: ${RawBucket.Arn}/*
          - Effect: Allow
            Action:
            - s3:ListBucket
            Resource:
            - Fn::GetAtt:
              - RawBucket
              - Arn
  AdCyberwatchIdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId:
        Ref: AdCyberwatchIdentityPool
      Roles:
        authenticated:
          Fn::GetAtt:
          - AdCyberwatchIdentityPoolRole
          - Arn
  AdCyberwatchHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: prod
      CorsConfiguration:
        AllowOrigins:
        - http://localhost:5173
        - http://localhost:5174
        AllowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        AllowHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Amz-Security-Token
        - X-Api-Key
        MaxAge: 3600
        AllowCredentials: true
      Auth:
        DefaultAuthorizer: CognitoJwt
        Authorizers:
          CognitoJwt:
            JwtConfiguration:
              issuer:
                Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${AdCyberwatchUserPool}
              audience:
              - Ref: AdCyberwatchUserPoolClient
            IdentitySource: $request.header.Authorization
  ApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-api
      Runtime: nodejs20.x
      Architectures:
      - x86_64
      Handler: src/handlers/api.handler
      CodeUri: ApiFunction
      MemorySize: 256
      Timeout: 30
      Environment:
        Variables:
          MAIN_TABLE_NAME:
            Ref: AdCyberwatchMainTable
          RAW_BUCKET:
            Ref: RawBucket
          CURATED_BUCKET:
            Ref: CuratedBucket
          FRAMEWORKS_BUCKET:
            Ref: FrameworksBucket
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdCyberwatchMainTable
      - Statement:
        - Effect: Allow
          Action:
          - s3:ListBucket
          Resource:
          - Fn::GetAtt:
            - RawBucket
            - Arn
          - Fn::GetAtt:
            - CuratedBucket
            - Arn
          - Fn::GetAtt:
            - FrameworksBucket
            - Arn
        - Effect: Allow
          Action:
          - s3:GetObject
          - s3:PutObject
          Resource:
          - Fn::Sub: ${RawBucket.Arn}/*
          - Fn::Sub: ${CuratedBucket.Arn}/*
          - Fn::Sub: ${FrameworksBucket.Arn}/*
      Events:
        Health:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: AdCyberwatchHttpApi
            Path: /health
            Method: GET
            Auth:
              Authorizer: NONE
        Me:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: AdCyberwatchHttpApi
            Path: /me
            Method: GET
        Presign:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: AdCyberwatchHttpApi
            Path: /uploads/presign
            Method: POST
    Metadata:
      SamResourceId: ApiFunction
  ApiFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ApiFunction}
      RetentionInDays: 7
  IngestOnRawObjectCreatedRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Trigger ingest on S3 raw Object Created (via EventBridge)
      EventPattern:
        source:
        - aws.s3
        detail-type:
        - Object Created
        detail:
          bucket:
            name:
            - Ref: RawBucket
      Targets:
      - Arn:
          Fn::GetAtt:
          - IngestFunction
          - Arn
        Id: IngestFunctionTarget
  AllowEventBridgeInvokeIngest:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: IngestFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - IngestOnRawObjectCreatedRule
        - Arn
  IngestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-ingest
      Runtime: python3.14
      Architectures:
      - x86_64
      Handler: src/handlers/ingest.handler
      CodeUri: IngestFunction
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          MAIN_TABLE_NAME:
            Ref: AdCyberwatchMainTable
          CURATED_BUCKET:
            Ref: CuratedBucket
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdCyberwatchMainTable
      - Statement:
        - Effect: Allow
          Action:
          - s3:GetObject
          Resource:
          - Fn::Sub: ${RawBucket.Arn}/*
        - Effect: Allow
          Action:
          - s3:PutObject
          Resource:
          - Fn::Sub: ${CuratedBucket.Arn}/*
    Metadata:
      SamResourceId: IngestFunction
  IngestFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${IngestFunction}
      RetentionInDays: 7
Outputs:
  RawBucketName:
    Value:
      Ref: RawBucket
  CuratedBucketName:
    Value:
      Ref: CuratedBucket
  FrameworksBucketName:
    Value:
      Ref: FrameworksBucket
  MainTableName:
    Value:
      Ref: AdCyberwatchMainTable
  UserPoolId:
    Value:
      Ref: AdCyberwatchUserPool
  UserPoolClientId:
    Value:
      Ref: AdCyberwatchUserPoolClient
  CognitoHostedUIUrl:
    Description: Cognito Hosted UI Login URL
    Value:
      Fn::Sub: https://poc-cyberwatch-ai.auth.${AWS::Region}.amazoncognito.com/login?client_id=${AdCyberwatchUserPoolClient}&response_type=code&redirect_uri=http://localhost:5173/callback
  IdentityPoolId:
    Description: Cognito Identity Pool ID for S3 access
    Value:
      Ref: AdCyberwatchIdentityPool
  IdentityPoolRoleArn:
    Description: IAM Role ARN for authenticated users via Cognito Identity
    Value:
      Fn::GetAtt:
      - AdCyberwatchIdentityPoolRole
      - Arn
  HttpApiUrl:
    Value:
      Fn::Sub: https://${AdCyberwatchHttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/prod
